<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Control de Horas Pro - Reporte PDF</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<style>
body{ font-family:'Segoe UI',sans-serif; background:#f8fafc; margin:0; padding:20px; }
h2,h3{margin:10px 0}
button{ background:#2563eb; color:white; padding:8px 14px; border-radius:8px; border:none; cursor:pointer; transition:0.2s; }
button:hover{background:#1d4ed8}
input{padding:8px; border-radius:6px; border:1px solid #ddd; margin:5px; font-size: 14px;}
.hidden{display:none}
.card{ background:white; border-radius:14px; padding:20px; box-shadow:0 10px 25px rgba(0,0,0,0.05); margin-bottom:20px; }
.dashboard{ display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:20px; margin:20px 0; }
table{ width:100%; border-collapse:collapse; background:white; margin-top: 10px; }
th,td{ padding:10px; border:1px solid #eee; text-align:center; }
th{background:#2563eb;color:white}
#loginBox{ max-width:400px; margin:80px auto; text-align:center; }
hr{ margin:15px 0; border:0; height:1px; background:#eee; }
.input-group { display: flex; flex-wrap: wrap; align-items: center; gap: 10px; }
.negativo { color: #dc2626; font-weight: bold; }
.btn-pdf { background: #e11d48; margin-left: 5px; } /* Color rojo para PDF */
</style>
</head>
<body>

<div id="loginBox" class="card">
<h2>Bienvenido al C√°lculo de tus Horas Laborales</h2>
<input type="email" id="loginUser" placeholder="Correo electr√≥nico"><br>
<input type="password" id="loginPass" placeholder="Contrase√±a"><br>
<button onclick="login()">Ingresar</button>
<button onclick="registrar()">Registrar</button>
<p id="loginMensaje"></p>
</div>

<div id="app" class="hidden">

<div class="card">
<h2 id="saludo"></h2>
<button onclick="logout()">Cerrar Sesi√≥n</button>
</div>

<div class="card">
<h3>Seleccionar Mes de Visualizaci√≥n</h3>
<input type="month" id="selectorMes">
<button onclick="cambiarMes()">Cambiar Mes</button>
<button onclick="generarPDF()" class="btn-pdf">üìÑ Descargar Reporte PDF</button>
</div>

<div class="card">
<h3>Configuraci√≥n y Descuentos</h3>
<div class="input-group">
    <div>Pago por hora ($): <input type="number" id="inputPagoHora" step="0.01"></div>
    <div>Otros Descuentos ($): <input type="number" id="inputOtrosDescuentos" step="0.01" value="0" oninput="dashboardMensual()"></div>
</div>
<br>
<button onclick="guardarConfiguracion()">Guardar Configuraci√≥n</button>
</div>

<div class="card">
<h3>Ingreso de Horas</h3>
<div class="input-group">
    <div>Fecha: <input type="date" id="fechaRegistro"></div>
    <div>Entrada: <input type="time" id="entrada"></div>
    <div>Salida Almuerzo: <input type="time" id="salidaAlm"></div>
    <div>Entrada Almuerzo: <input type="time" id="entradaAlm"></div>
    <div>Salida: <input type="time" id="salida"></div>
</div>
<br>
<button onclick="guardarDia()" style="background: #10b981;">Guardar Registro</button>
<button onclick="cancelarEdicion()" id="btnCancelar" class="hidden" style="background: #64748b;">Cancelar</button>
</div>

<div class="card" style="overflow-x:auto;">
<table>
<thead>
<tr>
<th>Fecha</th>
<th>Trabajadas</th>
<th>Normales</th>
<th>Extras</th>
<th>Acciones</th>
</tr>
</thead>
<tbody id="tablaBody"></tbody>
</table>
</div>

<div class="dashboard">
<div class="card"><p>Horas Normales</p><h3 id="mesNormales">0</h3></div>
<div class="card"><p>Horas Extras</p><h3 id="mesExtras">0</h3></div>
<div class="card"><p>Total Bruto Mes</p><h3 id="mesTotal">$0.00</h3></div>
</div>

<div class="card">
<h3>Resumen General Detallado</h3>
<p>Total Horas Normales: <span id="totalNormales">0.00</span></p>
<p>Total Horas Extras: <span id="totalExtras">0.00</span></p>
<hr>
<p>Total Bruto Horas Normales: $<span id="brutoNormales">0.00</span></p>
<p>Total Bruto Horas Extras: $<span id="brutoExtras">0.00</span></p>
<p><strong>Total Bruto General: $<span id="bruto">0.00</span></strong></p>
<hr>
<p>Deducciones de Ley (SS 9.75% + SE 1.25%): $<span id="deduccionesLey">0.00</span></p>
<p>Otros Descuentos (Adelantos/Multas): <span class="negativo">-$<span id="resumenOtrosDescuentos">0.00</span></span></p>
<hr>
<p>Total Neto SIN Extras: $<span id="netoSinExtras">0.00</span></p>
<p><strong>Total Neto CON Extras: $<span id="neto">0.00</span></strong></p>
</div>

<canvas id="graficaMes" style="max-height: 400px;"></canvas>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyA_c-ZFgW3punFLVpu1SYHYLaJAeQ4Uw7s",
  authDomain: "control-de-horas-66200.firebaseapp.com",
  projectId: "control-de-horas-66200",
  storageBucket: "control-de-horas-66200.firebasestorage.app",
  messagingSenderId: "554905911145",
  appId: "1:554905911145:web:5d6664ecf3f368256b87f8"
};

const appFirebase = initializeApp(firebaseConfig);
const db = getFirestore(appFirebase);
const auth = getAuth(appFirebase);

let usuarioActivo=null;
let datosUsuario=[];
let pagoHora=0;
let mesSeleccionado=new Date().toISOString().slice(0,7);
let grafica;
let editandoId=null;

document.getElementById('fechaRegistro').value = new Date().toISOString().split('T')[0];
selectorMes.value=mesSeleccionado;

onAuthStateChanged(auth, async user=>{
if(user){
usuarioActivo=user;
mostrarApp();
await cargarConfiguracion();
await cargarDatos();
}else{
loginBox.classList.remove("hidden");
app.classList.add("hidden");
}
});

window.login=async()=>{
try{ await signInWithEmailAndPassword(auth,loginUser.value,loginPass.value); }
catch(e){loginMensaje.innerText=e.message}
}

window.registrar=async()=>{
try{ await createUserWithEmailAndPassword(auth,loginUser.value,loginPass.value); }
catch(e){alert(e.message)}
}

window.logout=async()=>{await signOut(auth)}

function mostrarApp(){
loginBox.classList.add("hidden");
app.classList.remove("hidden");
saludo.innerText="Bienvenido "+usuarioActivo.email;
}

window.cambiarMes=async()=>{
mesSeleccionado=selectorMes.value;
await cargarDatos();
}

window.guardarConfiguracion=async()=>{
let valor=parseFloat(inputPagoHora.value) || 0;
let descuentos=parseFloat(inputOtrosDescuentos.value) || 0;
await setDoc(doc(db,"horas",usuarioActivo.uid,"configuracion","datos"),{
    pagoHora:valor,
    otrosDescuentos:descuentos
});
pagoHora=valor;
dashboardMensual();
}

async function cargarConfiguracion(){
const snap=await getDoc(doc(db,"horas",usuarioActivo.uid,"configuracion","datos"));
if(snap.exists()){
pagoHora=snap.data().pagoHora || 0;
inputPagoHora.value=pagoHora;
inputOtrosDescuentos.value=snap.data().otrosDescuentos || 0;
}
}

window.guardarDia=async()=>{
let fechaVal = fechaRegistro.value;
let entradaVal=entrada.value;
let salidaAlmVal=salidaAlm.value;
let entradaAlmVal=entradaAlm.value;
let salidaVal=salida.value;

if(!fechaVal || !entradaVal || !salidaVal || !salidaAlmVal || !entradaAlmVal)
return alert("Complete la fecha y todas las horas");

let inicio=new Date(`2024-01-01T${entradaVal}`);
let fin=new Date(`2024-01-01T${salidaVal}`);
let alm1=new Date(`2024-01-01T${salidaAlmVal}`);
let alm2=new Date(`2024-01-01T${entradaAlmVal}`);

if (fin < inicio) fin.setDate(fin.getDate() + 1);

let trabajadas=(fin-inicio-(alm2-alm1))/3600000;
if(trabajadas < 0) return alert("Error en el c√°lculo: Revise las horas de almuerzo.");

let normales=Math.min(trabajadas,8);
let extras=trabajadas>8?trabajadas-8:0;

let data={
fecha: fechaVal,
entrada:entradaVal,
salidaAlm:salidaAlmVal,
entradaAlm:entradaAlmVal,
salida:salidaVal,
trabajadas, normales, extras
};

try {
    if(editandoId){
    await updateDoc(doc(db,"horas",usuarioActivo.uid,"meses",mesSeleccionado,"registros",editandoId),data);
    editandoId=null;
    btnCancelar.classList.add("hidden");
    }else{
    await addDoc(collection(db,"horas",usuarioActivo.uid,"meses",mesSeleccionado,"registros"),data);
    }
    entrada.value="";salidaAlm.value="";entradaAlm.value="";salida.value="";
    fechaRegistro.value = new Date().toISOString().split('T')[0];
    await cargarDatos();
} catch (e) { alert("Error al guardar: " + e.message); }
}

window.cancelarEdicion = () => {
    editandoId = null;
    entrada.value="";salidaAlm.value="";entradaAlm.value="";salida.value="";
    btnCancelar.classList.add("hidden");
}

async function cargarDatos(){
datosUsuario=[];
tablaBody.innerHTML="";
const querySnapshot=await getDocs(collection(db,"horas",usuarioActivo.uid,"meses",mesSeleccionado,"registros"));
querySnapshot.forEach(docSnap=>{ datosUsuario.push({id:docSnap.id,...docSnap.data()}); });
datosUsuario.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
datosUsuario.forEach(d=>{
let fechaFormat = d.fecha.split('-').reverse().join('/');
tablaBody.innerHTML+=`
<tr>
<td>${fechaFormat}</td>
<td>${d.trabajadas.toFixed(2)}</td>
<td>${d.normales.toFixed(2)}</td>
<td>${d.extras.toFixed(2)}</td>
<td>
<button onclick="editarDia('${d.id}')" style="background:#f59e0b">‚úè</button>
<button onclick="eliminarDia('${d.id}')" style="background:#ef4444">üóë</button>
</td>
</tr>`;
});
dashboardMensual();
}

window.editarDia=function(id){
let registro=datosUsuario.find(d=>d.id===id);
if(!registro)return;
editandoId=id;
fechaRegistro.value = registro.fecha;
entrada.value=registro.entrada;
salidaAlm.value=registro.salidaAlm;
entradaAlm.value=registro.entradaAlm;
salida.value=registro.salida;
btnCancelar.classList.remove("hidden");
window.scrollTo(0,0);
}

window.eliminarDia=async function(id){
if(!confirm("¬øEliminar registro?"))return;
await deleteDoc(doc(db,"horas",usuarioActivo.uid,"meses",mesSeleccionado,"registros",id));
await cargarDatos();
}

window.dashboardMensual = function(){
let normales=0, extras=0;
let otrosDescuentos = parseFloat(document.getElementById('inputOtrosDescuentos').value) || 0;
datosUsuario.forEach(d=>{ normales+=d.normales; extras+=d.extras; });

let brutoNormales=normales*pagoHora;
let brutoExtras=extras*pagoHora;
let brutoTotal=brutoNormales+brutoExtras;

let ssTotal=brutoTotal*0.0975;
let seTotal=brutoTotal*0.0125;
let totalDeduccionesLey = ssTotal + seTotal;

let ssNormales = brutoNormales * 0.0975;
let seNormales = brutoNormales * 0.0125;
let netoSinExtras = brutoNormales - ssNormales - seNormales - otrosDescuentos;
let netoConExtras = brutoTotal - totalDeduccionesLey - otrosDescuentos;

mesNormales.innerText=normales.toFixed(2);
mesExtras.innerText=extras.toFixed(2);
mesTotal.innerText="$"+brutoTotal.toFixed(2);
totalNormales.innerText=normales.toFixed(2);
totalExtras.innerText=extras.toFixed(2);

document.getElementById("brutoNormales").innerText=brutoNormales.toFixed(2);
document.getElementById("brutoExtras").innerText=brutoExtras.toFixed(2);
document.getElementById("bruto").innerText=brutoTotal.toFixed(2);
document.getElementById("deduccionesLey").innerText=totalDeduccionesLey.toFixed(2);
document.getElementById("resumenOtrosDescuentos").innerText=otrosDescuentos.toFixed(2);
document.getElementById("netoSinExtras").innerText=netoSinExtras.toFixed(2);
document.getElementById("neto").innerText=netoConExtras.toFixed(2);

if(grafica)grafica.destroy();
let ctx=document.getElementById("graficaMes").getContext("2d");
grafica=new Chart(ctx,{
type:"bar",
data:{
labels:["Normales","Extras"],
datasets:[{ label: 'Horas', data:[normales,extras], backgroundColor: ['#2563eb', '#fbbf24'] }]
}
});
}

// --- L√ìGICA DE GENERACI√ìN DE PDF ---
window.generarPDF = function() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // T√≠tulo y Encabezado
    doc.setFontSize(18);
    doc.text("Reporte de Horas Laborales", 14, 20);
    doc.setFontSize(12);
    doc.text(`Colaborador: ${usuarioActivo.email}`, 14, 30);
    doc.text(`Mes Correspondiente: ${mesSeleccionado}`, 14, 37);
    doc.text(`Pago por Hora: $${pagoHora.toFixed(2)}`, 14, 44);

    // Tabla de Registros Diarios
    const filas = datosUsuario.map(d => [
        d.fecha.split('-').reverse().join('/'),
        d.entrada,
        d.salidaAlm,
        d.entradaAlm,
        d.salida,
        d.normales.toFixed(2),
        d.extras.toFixed(2),
        (d.trabajadas * pagoHora).toFixed(2)
    ]);

    doc.autoTable({
        startY: 50,
        head: [['Fecha', 'Ent.', 'S.Alm', 'E.Alm', 'Sal.', 'Norm.', 'Ext.', 'Subt. $']],
        body: filas,
        theme: 'striped',
        headStyles: { fillColor: [37, 99, 235] }
    });

    // Resumen Final al final de la tabla
    const finalY = doc.lastAutoTable.finalY + 10;
    
    doc.setFont("helvetica", "bold");
    doc.text("Resumen Mensual:", 14, finalY);
    doc.setFont("helvetica", "normal");
    
    doc.text(`Total Horas Normales: ${mesNormales.innerText}`, 14, finalY + 7);
    doc.text(`Total Horas Extras: ${mesExtras.innerText}`, 14, finalY + 14);
    doc.text(`Total Bruto: ${mesTotal.innerText}`, 14, finalY + 21);
    
    doc.setTextColor(225, 29, 72); // Color rojo para deducciones
    doc.text(`Deducciones Ley: -$${document.getElementById("deduccionesLey").innerText}`, 14, finalY + 28);
    doc.text(`Otros Descuentos: -$${document.getElementById("resumenOtrosDescuentos").innerText}`, 14, finalY + 35);
    
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(14);
    doc.text(`NETO A RECIBIR: $${document.getElementById("neto").innerText}`, 14, finalY + 45);

    // Guardar el archivo
    doc.save(`Reporte_Horas_${mesSeleccionado}.pdf`);
}

</script>
</body>
</html>
