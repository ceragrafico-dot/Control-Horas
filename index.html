<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Control de Horas Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{
font-family:'Segoe UI',sans-serif;
background:#f8fafc;
margin:0;
padding:20px;
}
h2,h3{margin:10px 0}
button{
background:#2563eb;
color:white;
padding:8px 14px;
border-radius:8px;
border:none;
cursor:pointer;
transition:0.2s;
}
button:hover{background:#1d4ed8}
input{padding:6px;border-radius:6px;border:1px solid #ddd;margin:5px}
.hidden{display:none}
.card{
background:white;
border-radius:14px;
padding:20px;
box-shadow:0 10px 25px rgba(0,0,0,0.05);
margin-bottom:20px;
}
.dashboard{
display:grid;
grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
gap:20px;
margin:20px 0;
}
table{
width:100%;
border-collapse:collapse;
background:white;
}
th,td{
padding:10px;
border:1px solid #eee;
text-align:center;
}
th{background:#2563eb;color:white}
#loginBox{
max-width:400px;
margin:80px auto;
text-align:center;
}
</style>
</head>
<body>

<div id="loginBox" class="card">
<h2>Bienvenido al C√°lculo de tus Horas Laborales</h2>
<input type="email" id="loginUser" placeholder="Correo electr√≥nico"><br>
<input type="password" id="loginPass" placeholder="Contrase√±a"><br>
<button onclick="login()">Ingresar</button>
<button onclick="registrar()">Registrar</button>
<p id="loginMensaje"></p>
</div>

<div id="app" class="hidden">

<div class="card">
<h2 id="saludo"></h2>
<button onclick="logout()">Cerrar Sesi√≥n</button>
</div>

<div class="card">
<h3>Seleccionar Mes</h3>
<input type="month" id="selectorMes">
<button onclick="cambiarMes()">Cambiar</button>
</div>

<div class="card">
<h3>Configuraci√≥n</h3>
Pago por hora:
<input type="number" id="inputPagoHora" step="0.01">
<button onclick="guardarConfiguracion()">Guardar Pago</button>
</div>

<div class="card">
<h3>Ingreso de Horas</h3>
Entrada <input type="time" id="entrada">
Salida Almuerzo <input type="time" id="salidaAlm">
Entrada Almuerzo <input type="time" id="entradaAlm">
Salida <input type="time" id="salida">
<br><br>
<button onclick="guardarDia()">Guardar D√≠a</button>
<button onclick="exportarExcel()">Exportar Excel</button>
<button onclick="exportarPDF()">Exportar PDF</button>
</div>

<div class="card">
<table>
<thead>
<tr>
<th>Fecha</th>
<th>Trabajadas</th>
<th>Normales</th>
<th>Extras</th>
<th>Acciones</th>
</tr>
</thead>
<tbody id="tablaBody"></tbody>
</table>
</div>

<div class="dashboard">
<div class="card"><p>Horas Normales</p><h3 id="mesNormales">0</h3></div>
<div class="card"><p>Horas Extras</p><h3 id="mesExtras">0</h3></div>
<div class="card"><p>Total Mes</p><h3 id="mesTotal">$0.00</h3></div>
</div>

<div class="card">
<h3>Resumen General del Mes</h3>
<p>Total Horas Normales: <span id="totalNormales">0.00</span></p>
<p>Total Horas Extras: <span id="totalExtras">0.00</span></p>
<p>Total Bruto: $<span id="bruto">0.00</span></p>
<p>Seguro Social (9.75%): $<span id="ss">0.00</span></p>
<p>Seguro Educativo (1.25%): $<span id="se">0.00</span></p>
<p><strong>Total Neto: $<span id="neto">0.00</span></strong></p>
</div>

<canvas id="graficaMes"></canvas>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyA_c-ZFgW3punFLVpu1SYHYLaJAeQ4Uw7s",
  authDomain: "control-de-horas-66200.firebaseapp.com",
  projectId: "control-de-horas-66200",
  storageBucket: "control-de-horas-66200.firebasestorage.app",
  messagingSenderId: "554905911145",
  appId: "1:554905911145:web:5d6664ecf3f368256b87f8"
};

const appFirebase = initializeApp(firebaseConfig);
const db = getFirestore(appFirebase);
const auth = getAuth(appFirebase);

let usuarioActivo=null;
let datosUsuario=[];
let pagoHora=0;
let mesSeleccionado=new Date().toISOString().slice(0,7);
let grafica;
let editandoId=null;

selectorMes.value=mesSeleccionado;

onAuthStateChanged(auth, async user=>{
if(user){
usuarioActivo=user;
mostrarApp();
await cargarConfiguracion();
await cargarDatos();
}else{
loginBox.classList.remove("hidden");
app.classList.add("hidden");
}
});

window.login=async()=>{
try{
await signInWithEmailAndPassword(auth,loginUser.value,loginPass.value);
}catch(e){loginMensaje.innerText=e.message}
}

window.registrar=async()=>{
try{
await createUserWithEmailAndPassword(auth,loginUser.value,loginPass.value);
}catch(e){alert(e.message)}
}

window.logout=async()=>{await signOut(auth)}

function mostrarApp(){
loginBox.classList.add("hidden");
app.classList.remove("hidden");
saludo.innerText="Bienvenido "+usuarioActivo.email;
}

window.cambiarMes=async()=>{
mesSeleccionado=selectorMes.value;
await cargarDatos();
}

window.guardarConfiguracion=async()=>{
let valor=parseFloat(inputPagoHora.value);
await setDoc(doc(db,"horas",usuarioActivo.uid,"configuracion","datos"),{pagoHora:valor});
pagoHora=valor;
dashboardMensual();
}

async function cargarConfiguracion(){
const snap=await getDoc(doc(db,"horas",usuarioActivo.uid,"configuracion","datos"));
if(snap.exists()){
pagoHora=snap.data().pagoHora;
inputPagoHora.value=pagoHora;
}
}

window.guardarDia=async()=>{
let entradaVal=entrada.value;
let salidaAlmVal=salidaAlm.value;
let entradaAlmVal=entradaAlm.value;
let salidaVal=salida.value;

if(!entradaVal||!salidaVal||!salidaAlmVal||!entradaAlmVal)
return alert("Complete todas las horas");

let fecha=new Date().toLocaleDateString('es-ES');

let inicio=new Date(`2024-01-01T${entradaVal}`);
let fin=new Date(`2024-01-01T${salidaVal}`);
let alm1=new Date(`2024-01-01T${salidaAlmVal}`);
let alm2=new Date(`2024-01-01T${entradaAlmVal}`);

let trabajadas=(fin-inicio-(alm2-alm1))/3600000;
let normales=Math.min(trabajadas,8);
let extras=trabajadas>8?trabajadas-8:0;

let data={fecha,entrada:entradaVal,salidaAlm:salidaAlmVal,entradaAlm:entradaAlmVal,salida:salidaVal,trabajadas,normales,extras};

if(editandoId){
await updateDoc(doc(db,"horas",usuarioActivo.uid,"meses",mesSeleccionado,"registros",editandoId),data);
editandoId=null;
}else{
await addDoc(collection(db,"horas",usuarioActivo.uid,"meses",mesSeleccionado,"registros"),data);
}

entrada.value="";salidaAlm.value="";entradaAlm.value="";salida.value="";
await cargarDatos();
}

async function cargarDatos(){
datosUsuario=[];
tablaBody.innerHTML="";

const querySnapshot=await getDocs(collection(db,"horas",usuarioActivo.uid,"meses",mesSeleccionado,"registros"));

querySnapshot.forEach(docSnap=>{
datosUsuario.push({id:docSnap.id,...docSnap.data()});
});

datosUsuario.forEach(d=>{
tablaBody.innerHTML+=`
<tr>
<td>${d.fecha}</td>
<td>${d.trabajadas.toFixed(2)}</td>
<td>${d.normales.toFixed(2)}</td>
<td>${d.extras.toFixed(2)}</td>
<td>
<button onclick="editarDia('${d.id}')">‚úè</button>
<button onclick="eliminarDia('${d.id}')">üóë</button>
</td>
</tr>`;
});

dashboardMensual();
}

/* üîπ CORRECCI√ìN AGREGADA AQU√ç üîπ */

window.editarDia = function(id){
let registro = datosUsuario.find(d => d.id === id);
if(!registro) return;

editandoId = id;
entrada.value = registro.entrada;
salidaAlm.value = registro.salidaAlm;
entradaAlm.value = registro.entradaAlm;
salida.value = registro.salida;
}

window.eliminarDia = async function(id){
if(!confirm("¬øEliminar registro?")) return;

await deleteDoc(
doc(db,"horas",usuarioActivo.uid,"meses",mesSeleccionado,"registros",id)
);

await cargarDatos();
}

/* üîπ FIN DE CORRECCI√ìN üîπ */

function dashboardMensual(){

let normales=0;
let extras=0;

datosUsuario.forEach(d=>{
normales+=d.normales;
extras+=d.extras;
});

let brutoCalc=(normales+extras)*pagoHora;
let ssCalc=brutoCalc*0.0975;
let seCalc=brutoCalc*0.0125;
let netoCalc=brutoCalc-ssCalc-seCalc;

mesNormales.innerText=normales.toFixed(2);
mesExtras.innerText=extras.toFixed(2);
mesTotal.innerText="$"+brutoCalc.toFixed(2);

totalNormales.innerText=normales.toFixed(2);
totalExtras.innerText=extras.toFixed(2);
document.getElementById("bruto").innerText=brutoCalc.toFixed(2);
document.getElementById("ss").innerText=ssCalc.toFixed(2);
document.getElementById("se").innerText=seCalc.toFixed(2);
document.getElementById("neto").innerText=netoCalc.toFixed(2);

if(grafica)grafica.destroy();

let ctx=document.getElementById("graficaMes").getContext("2d");
grafica=new Chart(ctx,{
type:"bar",
data:{
labels:["Normales","Extras"],
datasets:[{data:[normales,extras]}]
}
});
}

</script>
</body>
</html>
