<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Cálculo de Horas Laborales</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:Arial;margin:0;background:#f4f6f9}
.container{max-width:1100px;margin:auto;padding:20px}
.card{background:white;padding:20px;border-radius:10px;margin-bottom:20px;box-shadow:0 4px 10px rgba(0,0,0,0.05)}
input,button,select{padding:8px;margin:5px}
button{cursor:pointer;border:none;border-radius:6px;background:#2563eb;color:white}
button:hover{opacity:.9}
table{width:100%;border-collapse:collapse;margin-top:15px}
th,td{border:1px solid #ddd;padding:8px;text-align:center}
th{background:#2563eb;color:white}
.resumen{background:#f1f5f9;padding:15px;border-radius:10px}
.hidden{display:none}
.topbar{display:flex;justify-content:space-between;align-items:center}
</style>
</head>
<body>

<div id="welcomeScreen" class="container card">
<h2>Bienvenido al Cálculo de tus horas laborales</h2>
<button onclick="mostrarLogin()">Iniciar</button>
</div>

<div id="loginScreen" class="container card hidden">
<h3>Login</h3>
<input type="email" id="email" placeholder="Email"><br>
<input type="password" id="password" placeholder="Contraseña"><br>
<button onclick="login()">Ingresar</button>
<button onclick="register()">Registrar</button>
</div>

<div id="app" class="hidden">
<div class="container">

<div class="topbar">
<h2>Panel de Horas</h2>
<button onclick="logout()">Cerrar sesión</button>
</div>

<div class="card">
<label>Seleccionar Mes:</label>
<input type="month" id="mesSelector">
<button onclick="cambiarMes()">Cambiar</button>
</div>

<div class="card">
<h3>Ingreso de Horas</h3>
<input type="time" id="entrada">
<input type="time" id="salidaAlm">
<input type="time" id="entradaAlm">
<input type="time" id="salida">
<button onclick="guardarDia()">Guardar Día</button>
</div>

<div class="card">
<h3>Registros</h3>
<table>
<thead>
<tr>
<th>Fecha</th>
<th>Entrada</th>
<th>Salida Alm</th>
<th>Entrada Alm</th>
<th>Salida</th>
<th>Normales</th>
<th>Extras</th>
<th>Acciones</th>
</tr>
</thead>
<tbody id="tabla"></tbody>
</table>
</div>

<div class="card resumen">
<h3>Resumen General</h3>
<p>Total Horas Normales: <span id="totalNormales">0.00</span></p>
<p>Total Horas Extras: <span id="totalExtras">0.00</span></p>
<p>Total Bruto: $<span id="bruto">0.00</span></p>
<p>Seguro Social (9.75%): $<span id="ss">0.00</span></p>
<p>Seguro Educativo (1.25%): $<span id="se">0.00</span></p>
<p>Total Neto: $<span id="neto">0.00</span></p>
</div>

</div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
apiKey: "AIzaSyA_c-ZFgW3punFLVpu1SYHYLaJAeQ4Uw7s",
authDomain: "control-de-horas-66200.firebaseapp.com",
projectId: "control-de-horas-66200",
storageBucket: "control-de-horas-66200.firebasestorage.app",
messagingSenderId: "554905911145",
appId: "1:554905911145:web:5d6664ecf3f368256b87f8"
};

const appFirebase = initializeApp(firebaseConfig);
const auth = getAuth(appFirebase);
const db = getFirestore(appFirebase);

let usuarioActivo=null;
let mesSeleccionado=new Date().toISOString().slice(0,7);
let editandoId=null;

document.getElementById("mesSelector").value=mesSeleccionado;

function mostrarLogin(){
document.getElementById("welcomeScreen").classList.add("hidden");
document.getElementById("loginScreen").classList.remove("hidden");
}

function mostrarApp(){
const welcome=document.getElementById("welcomeScreen");
const login=document.getElementById("loginScreen");
const app=document.getElementById("app");
if(welcome) welcome.classList.add("hidden");
if(login) login.classList.add("hidden");
if(app) app.classList.remove("hidden");
}

window.login=async function(){
await signInWithEmailAndPassword(auth,email.value,password.value);
}

window.register=async function(){
await createUserWithEmailAndPassword(auth,email.value,password.value);
}

window.logout=async function(){
await signOut(auth);
location.reload();
}

onAuthStateChanged(auth,user=>{
if(user){
usuarioActivo=user;
mostrarApp();
cargarDatos();
}else{
document.getElementById("welcomeScreen").classList.remove("hidden");
}
});

window.cambiarMes=function(){
mesSeleccionado=document.getElementById("mesSelector").value;
cargarDatos();
}

window.guardarDia=async function(){

let entradaVal=document.getElementById("entrada").value;
let salidaAlmVal=document.getElementById("salidaAlm").value;
let entradaAlmVal=document.getElementById("entradaAlm").value;
let salidaVal=document.getElementById("salida").value;

if(!entradaVal||!salidaVal||!salidaAlmVal||!entradaAlmVal)
return alert("Complete todas las horas");

let fecha=new Date().toLocaleDateString('es-ES');

let inicio=new Date(`2024-01-01T${entradaVal}`);
let fin=new Date(`2024-01-01T${salidaVal}`);
let alm1=new Date(`2024-01-01T${salidaAlmVal}`);
let alm2=new Date(`2024-01-01T${entradaAlmVal}`);

let trabajadas=(fin-inicio-(alm2-alm1))/3600000;
let normales=Math.min(trabajadas,8);
let extras=trabajadas>8?trabajadas-8:0;

let data={fecha,entrada:entradaVal,salidaAlm:salidaAlmVal,entradaAlm:entradaAlmVal,salida:salidaVal,normales,extras};

if(editandoId){
await updateDoc(doc(db,"horas",usuarioActivo.uid,"meses",mesSeleccionado,"registros",editandoId),data);
editandoId=null;
}else{
await addDoc(collection(db,"horas",usuarioActivo.uid,"meses",mesSeleccionado,"registros"),data);
}

document.querySelectorAll("input[type=time]").forEach(i=>i.value="");
cargarDatos();
}

async function cargarDatos(){
const tabla=document.getElementById("tabla");
tabla.innerHTML="";
let totalNormales=0,totalExtras=0;

const querySnapshot=await getDocs(collection(db,"horas",usuarioActivo.uid,"meses",mesSeleccionado,"registros"));

querySnapshot.forEach(docu=>{
let d=docu.data();
totalNormales+=d.normales;
totalExtras+=d.extras;

tabla.innerHTML+=`
<tr>
<td>${d.fecha}</td>
<td>${d.entrada}</td>
<td>${d.salidaAlm}</td>
<td>${d.entradaAlm}</td>
<td>${d.salida}</td>
<td>${d.normales.toFixed(2)}</td>
<td>${d.extras.toFixed(2)}</td>
<td>
<button onclick="editar('${docu.id}','${d.entrada}','${d.salidaAlm}','${d.entradaAlm}','${d.salida}')">Editar</button>
<button onclick="eliminar('${docu.id}')">X</button>
</td>
</tr>
`;
});

document.getElementById("totalNormales").innerText=totalNormales.toFixed(2);
document.getElementById("totalExtras").innerText=totalExtras.toFixed(2);

let bruto=totalNormales*5+totalExtras*7.5;
let ss=bruto*0.0975;
let se=bruto*0.0125;
let neto=bruto-ss-se;

document.getElementById("bruto").innerText=bruto.toFixed(2);
document.getElementById("ss").innerText=ss.toFixed(2);
document.getElementById("se").innerText=se.toFixed(2);
document.getElementById("neto").innerText=neto.toFixed(2);
}

window.eliminar=async function(id){
await deleteDoc(doc(db,"horas",usuarioActivo.uid,"meses",mesSeleccionado,"registros",id));
cargarDatos();
}

window.editar=function(id,entrada,salidaAlm,entradaAlm,salida){
document.getElementById("entrada").value=entrada;
document.getElementById("salidaAlm").value=salidaAlm;
document.getElementById("entradaAlm").value=entradaAlm;
document.getElementById("salida").value=salida;
editandoId=id;
}

</script>

</body>
</html>
